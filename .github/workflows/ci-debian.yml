# Copyright (C) 2023, RTE (http://www.rte-france.com)
# SPDX-License-Identifier: Apache-2.0

name: CI debian

on:
  pull_request:
    types: [opened, reopened, edited, review_requested]
    branches: [debian-main]

jobs:
  ci:
    runs-on: self-hosted
    steps:
      - name: Configure Sources
        run: 
            echo $GITHUB_REF;
            echo $GITHUB_RUN_ATTEMPT;
            PR_N=`echo $GITHUB_REF | cut -d '/' -f 3`;
            CI_DIR=/tmp/seapath_ci_PR-${PR_N}_${GITHUB_RUN_ATTEMPT};
            mkdir $CI_DIR; cd $CI_DIR;
            git clone -q --depth 1 -b main https://github.com/eroussy/ci-seapath ci;
            echo "CI sources downloaded successfully";
            ci/launch.sh config;
      - name: Setup Debian
        run: PR_N=`echo $GITHUB_REF | cut -d '/' -f 3`;
             CI_DIR=/tmp/seapath_ci_PR-${PR_N}_${GITHUB_RUN_ATTEMPT};
             $CI_DIR/ci/launch.sh setup
      - name: Launch test
        run: PR_N=`echo $GITHUB_REF | cut -d '/' -f 3`;
             CI_DIR=/tmp/seapath_ci_PR-${PR_N}_${GITHUB_RUN_ATTEMPT};
             $CI_DIR/ci/launch.sh test
      - name: Generate test report
        run: PR_N=`echo $GITHUB_REF | cut -d '/' -f 3`;
             CI_DIR=/tmp/seapath_ci_PR-${PR_N}_${GITHUB_RUN_ATTEMPT};
             $CI_DIR/ci/launch.sh report
      - name: clean
        run: PR_N=`echo $GITHUB_REF | cut -d '/' -f 3`;
             CI_DIR=/tmp/seapath_ci_PR-${PR_N}_${GITHUB_RUN_ATTEMPT};
             $CI_DIR/ci/launch.sh clean
